name: Release Build and Deploy

on:
  release:
    types: [published]
  # æ·»åŠ æ‰‹åŠ¨è§¦å‘ï¼Œæ”¯æŒé‡æ–°å‘å¸ƒ
  workflow_dispatch:
    inputs:
      tag:
        description: 'è¦é‡æ–°å‘å¸ƒçš„ç‰ˆæœ¬æ ‡ç­¾ (ä¾‹å¦‚: 1.0.2)'
        required: true
        type: string
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»º (å³ä½¿æ–‡ä»¶å·²å­˜åœ¨)'
        required: false
        default: false
        type: boolean

jobs:
  build-and-release:
    name: æ„å»ºå¹¶å‘å¸ƒç¨‹åºåŒ…
    runs-on: ubuntu-latest
    # æ·»åŠ æ˜ç¡®çš„æƒé™
    permissions:
      contents: write
      packages: read

    strategy:
      matrix:
        node-version: [18]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œæµ‹è¯•å’Œä»£ç æ£€æŸ¥
        run: |
          npm run lint
          npm run build

      - name: åˆ›å»ºä¸´æ—¶ç¯å¢ƒé…ç½®
        run: |
          cp .env.example .env
          echo "VOLCENGINE_API_KEY=ci_test_key" >> .env
          echo "DASHSCOPE_API_KEY=ci_test_key" >> .env

      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          # å¤„ç†ç‰ˆæœ¬å· - æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥çš„æ ‡ç­¾ï¼Œå¦åˆ™ä½¿ç”¨releaseæ ‡ç­¾
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RAW_VERSION="${{ github.event.inputs.tag }}"
            echo "æ‰‹åŠ¨è§¦å‘å‘å¸ƒï¼Œç‰ˆæœ¬: ${RAW_VERSION}"
          else
            RAW_VERSION="${{ github.event.release.tag_name }}"
            echo "Releaseè§¦å‘å‘å¸ƒï¼Œç‰ˆæœ¬: ${RAW_VERSION}"
          fi

          # æ„å»ºäº§ç‰©ä½¿ç”¨vå‰ç¼€ç‰ˆæœ¬ï¼Œtagä¿æŒåŸå§‹æ ¼å¼
          if [[ $RAW_VERSION == v* ]]; then
            # å¦‚æœtagå·²ç»æœ‰vå‰ç¼€ï¼Œå»æ‰vä½œä¸ºåŸå§‹ç‰ˆæœ¬
            CLEAN_VERSION="${RAW_VERSION#v}"
            VERSION="v${CLEAN_VERSION}"
          else
            # å¦‚æœtagæ²¡æœ‰vå‰ç¼€ï¼Œä¿æŒåŸæ ·ä½œä¸ºåŸå§‹ç‰ˆæœ¬ï¼Œæ„å»ºæ—¶æ·»åŠ vå‰ç¼€
            CLEAN_VERSION="${RAW_VERSION}"
            VERSION="v${RAW_VERSION}"
            echo "Tagä¸å¸¦vå‰ç¼€ï¼Œæ„å»ºäº§ç‰©å°†ä½¿ç”¨: ${VERSION}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "raw_version=${RAW_VERSION}" >> $GITHUB_OUTPUT
          echo "clean_version=${CLEAN_VERSION}" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶é‡æ–°æ„å»º
        id: check_rebuild
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          FORCE_REBUILD="${{ github.event.inputs.force_rebuild }}"

          # æ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
          BINARIES_EXIST=false
          if [ -d "binaries" ] && [ "$(ls -A binaries/)" ]; then
            echo "å‘ç°å·²å­˜åœ¨çš„äºŒè¿›åˆ¶æ–‡ä»¶"
            ls -la binaries/
            BINARIES_EXIST=true
          fi

          # æ£€æŸ¥å‘å¸ƒåŒ…æ˜¯å¦å·²å­˜åœ¨
          RELEASES_EXIST=false
          if [ -d "releases" ] && [ "$(ls -A releases/)" ]; then
            echo "å‘ç°å·²å­˜åœ¨çš„å‘å¸ƒåŒ…"
            ls -la releases/
            RELEASES_EXIST=true
          fi

          # å†³å®šæ˜¯å¦éœ€è¦é‡æ–°æ„å»º
          if [ "$FORCE_REBUILD" = "true" ]; then
            echo "å¼ºåˆ¶é‡æ–°æ„å»ºæ¨¡å¼"
            echo "need_build=true" >> $GITHUB_OUTPUT
            echo "need_package=true" >> $GITHUB_OUTPUT
          elif [ "$BINARIES_EXIST" = "false" ]; then
            echo "äºŒè¿›åˆ¶æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦æ„å»º"
            echo "need_build=true" >> $GITHUB_OUTPUT
            echo "need_package=true" >> $GITHUB_OUTPUT
          elif [ "$RELEASES_EXIST" = "false" ]; then
            echo "å‘å¸ƒåŒ…ä¸å­˜åœ¨ï¼Œéœ€è¦æ‰“åŒ…"
            echo "need_build=false" >> $GITHUB_OUTPUT
            echo "need_package=true" >> $GITHUB_OUTPUT
          else
            echo "æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡æ„å»º"
            echo "need_build=false" >> $GITHUB_OUTPUT
            echo "need_package=false" >> $GITHUB_OUTPUT
          fi

      - name: æ„å»ºæ‰€æœ‰å¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
        if: steps.check_rebuild.outputs.need_build == 'true'
        run: |
          echo "å¼€å§‹æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶..."
          npm run build:binaries

      - name: éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
        run: |
          echo "éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶..."
          if [ ! -d "binaries" ] || [ ! "$(ls -A binaries/)" ]; then
            echo "âŒ äºŒè¿›åˆ¶æ–‡ä»¶ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
            exit 1
          fi
          npm run verify:binaries

      - name: åˆ›å»ºå‘å¸ƒåŒ…
        if: steps.check_rebuild.outputs.need_package == 'true'
        run: |
          echo "åˆ›å»ºå‘å¸ƒåŒ…..."
          npm run create:release

      - name: éªŒè¯å‘å¸ƒåŒ…
        run: |
          echo "éªŒè¯å‘å¸ƒåŒ…..."
          if [ ! -d "releases" ] || [ ! "$(ls -A releases/)" ]; then
            echo "âŒ å‘å¸ƒåŒ…ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
            exit 1
          fi
          npm run verify:releases

      - name: åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶
        run: |
          echo "ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶:"
          ls -la binaries/
          echo ""
          echo "ç”Ÿæˆçš„å‘å¸ƒåŒ…:"
          ls -la releases/

      - name: æ£€æŸ¥å¹¶æ¸…ç†å‘å¸ƒæ–‡ä»¶
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          RAW_VERSION="${{ steps.get_version.outputs.raw_version }}"

          cd releases/

          echo "æ„å»ºç”Ÿæˆçš„åŸå§‹æ–‡ä»¶åˆ—è¡¨:"
          ls -la

          # åˆ é™¤å¯èƒ½çš„é‡å¤æˆ–é”™è¯¯æ–‡ä»¶
          echo "æ¸…ç†é‡å¤å’Œé”™è¯¯çš„æ–‡ä»¶..."

          # åˆ é™¤åŒvå‰ç¼€çš„æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          rm -f universal-ollama-proxy-v*v*.* 2>/dev/null || true

          # åˆ é™¤æ²¡æœ‰vå‰ç¼€çš„ä¸æ­£ç¡®æ ¼å¼æ–‡ä»¶ï¼ˆä¸åˆ é™¤æ­£ç¡®çš„vå‰ç¼€æ–‡ä»¶ï¼‰
          rm -f universal-ollama-proxy-${RAW_VERSION}-*.* 2>/dev/null || true

          # ç¡®ä¿åªä¿ç•™æ­£ç¡®æ ¼å¼çš„æ–‡ä»¶ï¼ˆvå‰ç¼€ç‰ˆæœ¬ï¼‰
          echo "æ¸…ç†åçš„æ–‡ä»¶åˆ—è¡¨:"
          ls -la

          # éªŒè¯Windows zipæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          WIN_X64_ZIP="universal-ollama-proxy-${VERSION}-windows-x64.zip"
          WIN_ARM64_ZIP="universal-ollama-proxy-${VERSION}-windows-arm64.zip"

          if [ ! -f "$WIN_X64_ZIP" ]; then
            echo "âŒ ç¼ºå°‘Windows x64 ZIPæ–‡ä»¶: $WIN_X64_ZIP"
            exit 1
          fi

          if [ ! -f "$WIN_ARM64_ZIP" ]; then
            echo "âŒ ç¼ºå°‘Windows ARM64 ZIPæ–‡ä»¶: $WIN_ARM64_ZIP"
            exit 1
          fi

          echo "âœ… æ‰€æœ‰Windows ZIPæ–‡ä»¶æ£€æŸ¥é€šè¿‡"
          echo "æœ€ç»ˆå‘å¸ƒæ–‡ä»¶åˆ—è¡¨:"
          ls -la universal-ollama-proxy-${VERSION}-*

      - name: æ£€æŸ¥å¹¶è®¾ç½®Releaseæè¿°
        id: set_release_body
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          RAW_VERSION="${{ steps.get_version.outputs.raw_version }}"

          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œæˆ–è€…releaseæè¿°ä¸ºç©ºï¼Œåˆ™è®¾ç½®é»˜è®¤æè¿°
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "æ‰‹åŠ¨è§¦å‘ï¼Œè®¾ç½®é»˜è®¤Releaseæè¿°"
            SHOULD_SET_BODY=true
          else
            # æ£€æŸ¥releaseæè¿°æ˜¯å¦ä¸ºç©º
            RELEASE_BODY="${{ github.event.release.body }}"
            if [ -z "$RELEASE_BODY" ] || [ "$RELEASE_BODY" = "null" ]; then
              echo "Releaseæè¿°ä¸ºç©ºï¼Œè®¾ç½®é»˜è®¤æè¿°"
              SHOULD_SET_BODY=true
            else
              echo "Releaseå·²æœ‰æè¿°ï¼Œä¿æŒä¸å˜"
              SHOULD_SET_BODY=false
            fi
          fi

          if [ "$SHOULD_SET_BODY" = "true" ]; then
            # åˆ›å»ºé»˜è®¤Releaseæè¿°
            cat > release_body.md << 'EOF'
          # ğŸš€ Universal Ollama Proxy ${{ steps.get_version.outputs.version }} å‘å¸ƒ

          **ç»Ÿä¸€çš„ AI æœåŠ¡ä»£ç†** - ä¸“ä¸º GitHub Copilot Chat çš„ Ollama æ¥å…¥ä¼˜åŒ–ï¼Œæä¾›å…¶è°ƒç”¨æ‰€ä½¿ç”¨åˆ°çš„å…¼å®¹æ¥å£ã€‚

          ## âœ¨ ä¸»è¦ç‰¹æ€§

          - ğŸ”Œ **å¤šä¾›åº”å•†æ”¯æŒ** - ç«å±±æ–¹èˆŸå¼•æ“ã€é˜¿é‡Œäº‘ç™¾ç‚¼ã€DeepSeekã€è…¾è®¯äº‘ã€OpenRouter
          - ğŸ”„ **ç»Ÿä¸€æ¥å£** - æ ‡å‡† OpenAI æ ¼å¼ï¼Œ`provider:model` å‘½åè§„èŒƒ
          - ğŸ”§ **è·¨å¹³å°** - æ”¯æŒ Windows/Linux/macOS, x64/ARM64 æ¶æ„
          - ğŸ› ï¸ **å·¥å…·é›†æˆ** - ä¸º GitHub Copilot Chat ä¼˜åŒ–çš„æ¥å£

          ## ğŸ“¥ ä¸‹è½½ä¸å®‰è£…

          | æ“ä½œç³»ç»Ÿ | æ¶æ„ | ä¸‹è½½æ–‡ä»¶ |
          |---------|-----|---------|
          | Windows | x64 | `universal-ollama-proxy-${{ steps.get_version.outputs.version }}-windows-x64.zip` |
          | Windows | ARM64 | `universal-ollama-proxy-${{ steps.get_version.outputs.version }}-windows-arm64.zip` |
          | Linux | x64 | `universal-ollama-proxy-${{ steps.get_version.outputs.version }}-linux-x64.tar.gz` |
          | Linux | ARM64 | `universal-ollama-proxy-${{ steps.get_version.outputs.version }}-linux-arm64.tar.gz` |
          | macOS | x64 | `universal-ollama-proxy-${{ steps.get_version.outputs.version }}-macos-x64.tar.gz` |
          | macOS | ARM64 | `universal-ollama-proxy-${{ steps.get_version.outputs.version }}-macos-arm64.tar.gz` |

          ## ğŸš€ å¿«é€Ÿå¼€å§‹

          1. ä¸‹è½½å¹¶è§£å‹
          2. å¤åˆ¶ `.env.example` ä¸º `.env` å¹¶æ·»åŠ æ‚¨çš„ API Keys
          3. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼ŒæœåŠ¡é»˜è®¤ç›‘å¬ http://localhost:11434
          4. åœ¨ GitHub Copilot Chat ä¸­ä½¿ç”¨ `provider:model` æ ¼å¼è®¿é—®æ¨¡å‹

          ## ğŸ“š ç›¸å…³é“¾æ¥

          - [è¯¦ç»†æ–‡æ¡£](https://github.com/VicBilibily/universal-ollama-proxy/blob/main/README.md)
          - [é—®é¢˜åé¦ˆ](https://github.com/VicBilibily/universal-ollama-proxy/issues)
          - [é¡¹ç›®ä¸»é¡µ](https://github.com/VicBilibily/universal-ollama-proxy)

          ---

          **æ„Ÿè°¢æ‚¨é€‰æ‹© Universal Ollama Proxyï¼** ğŸ‰
          EOF
            echo "use_default_body=true" >> $GITHUB_OUTPUT
          else
            echo "use_default_body=false" >> $GITHUB_OUTPUT
          fi

      - name: ä¸Šä¼ å‘å¸ƒèµ„äº§åˆ° GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.raw_version }}
          files: |
            releases/universal-ollama-proxy-${{ steps.get_version.outputs.version }}-*.zip
            releases/universal-ollama-proxy-${{ steps.get_version.outputs.version }}-*.tar.gz
          token: ${{ secrets.GITHUB_TOKEN }}
          body_path: ${{ steps.set_release_body.outputs.use_default_body == 'true' && 'release_body.md' || '' }}
          append_body: ${{ steps.set_release_body.outputs.use_default_body == 'false' }}

      - name: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        run: |
          echo "## ğŸ“Š æ„å»ºæŠ¥å‘Š" > build-report.md
          echo "" >> build-report.md
          echo "### ğŸ—ï¸ æ„å»ºä¿¡æ¯" >> build-report.md
          echo "- **ç‰ˆæœ¬:** ${{ steps.get_version.outputs.version }}" >> build-report.md
          echo "- **æ„å»ºæ—¶é—´:** $(date -u)" >> build-report.md
          echo "- **Node.js ç‰ˆæœ¬:** ${{ matrix.node-version }}" >> build-report.md
          echo "- **å¹³å°:** $(uname -a)" >> build-report.md
          echo "- **è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> build-report.md
          echo "" >> build-report.md
          echo "### ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶" >> build-report.md
          echo "" >> build-report.md
          echo "#### äºŒè¿›åˆ¶æ–‡ä»¶" >> build-report.md
          echo '```' >> build-report.md
          ls -la binaries/ >> build-report.md
          echo '```' >> build-report.md
          echo "" >> build-report.md
          echo "#### å‘å¸ƒåŒ…" >> build-report.md
          echo '```' >> build-report.md
          ls -la releases/ >> build-report.md
          echo '```' >> build-report.md

      - name: ä¸Šä¼ æ„å»ºæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: build-report-${{ steps.get_version.outputs.version }}
          path: build-report.md

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ steps.get_version.outputs.version }}
          path: |
            binaries/
            releases/
          retention-days: 30

      - name: æ„å»ºæˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ å‘å¸ƒæ„å»ºæˆåŠŸå®Œæˆ!"
          echo "ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "ç”Ÿæˆçš„æ–‡ä»¶æ•°é‡:"
          echo "  - äºŒè¿›åˆ¶æ–‡ä»¶: $(ls -1 binaries/ | wc -l) ä¸ª"
          echo "  - å‘å¸ƒåŒ…: $(ls -1 releases/ | wc -l) ä¸ª"
          echo "æ„å»ºæ—¶é—´: $(date -u)"

      - name: æ„å»ºå¤±è´¥å¤„ç†
        if: failure()
        run: |
          echo "âŒ å‘å¸ƒæ„å»ºå¤±è´¥!"
          echo "è¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹:"
          echo "  - ä»£ç ç¼–è¯‘æ˜¯å¦æˆåŠŸ"
          echo "  - ä¾èµ–å®‰è£…æ˜¯å¦æ­£å¸¸"
          echo "  - ç¯å¢ƒå˜é‡é…ç½®æ˜¯å¦æ­£ç¡®"
          echo "  - ç½‘ç»œè¿æ¥æ˜¯å¦ç¨³å®š"
          echo ""
          echo "ğŸ’¡ é‡æ–°å‘å¸ƒæ–¹æ³•:"
          echo "  1. è¿›å…¥ Actions é¡µé¢"
          echo "  2. é€‰æ‹© 'Release Build and Deploy' å·¥ä½œæµ"
          echo "  3. ç‚¹å‡» 'Run workflow'"
          echo "  4. è¾“å…¥ç‰ˆæœ¬å·: ${{ steps.get_version.outputs.version }}"
          echo "  5. é€‰æ‹©æ˜¯å¦å¼ºåˆ¶é‡æ–°æ„å»º"
          echo ""
          echo "è¯¦ç»†æ—¥å¿—è¯·æŸ¥çœ‹ Actions é¡µé¢"
          exit 1
