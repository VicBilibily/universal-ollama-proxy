name: Release Build and Deploy

on:
  release:
    types: [published, created, prereleased]

jobs:
  build-and-release:
    name: æ„å»ºå¹¶å‘å¸ƒç¨‹åºåŒ…
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œæµ‹è¯•å’Œä»£ç æ£€æŸ¥
        run: |
          npm run lint
          npm run build

      - name: æ„å»ºæ‰€æœ‰å¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
        run: npm run build:binaries

      - name: éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
        run: npm run verify:binaries

      - name: åˆ›å»ºå‘å¸ƒåŒ…
        run: npm run create:release

      - name: éªŒè¯å‘å¸ƒåŒ…
        run: npm run verify:releases

      - name: åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶
        run: |
          echo "ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶:"
          ls -la binaries/
          echo "ç”Ÿæˆçš„å‘å¸ƒåŒ…:"
          ls -la releases/

      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å‘å¸ƒèµ„äº§åˆ° GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            releases/*.zip
            releases/*.tar.gz
          body: |
            ## ğŸš€ å‘å¸ƒè¯´æ˜

            ### ğŸ“¦ ä¸‹è½½

            #### Windows
            - `universal-ollama-proxy-${{ steps.get_version.outputs.version }}-windows-x64.zip` - Windows x64
            - `universal-ollama-proxy-${{ steps.get_version.outputs.version }}-windows-arm64.zip` - Windows ARM64

            #### Linux
            - `universal-ollama-proxy-${{ steps.get_version.outputs.version }}-linux-x64.tar.gz` - Linux x64
            - `universal-ollama-proxy-${{ steps.get_version.outputs.version }}-linux-arm64.tar.gz` - Linux ARM64

            #### macOS
            - `universal-ollama-proxy-${{ steps.get_version.outputs.version }}-macos-x64.tar.gz` - macOS Intel
            - `universal-ollama-proxy-${{ steps.get_version.outputs.version }}-macos-arm64.tar.gz` - macOS Apple Silicon

            ### ğŸ”§ ä½¿ç”¨æ–¹æ³•

            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
            2. è§£å‹åˆ°ç›®æ ‡ç›®å½•
            3. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¤åˆ¶ `.env.example` ä¸º `.env`ï¼‰
            4. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶

            ### ğŸ“‹ éªŒè¯ä¿¡æ¯

            - âœ… æ‰€æœ‰å¹³å°æ„å»ºå®Œæˆ
            - âœ… äºŒè¿›åˆ¶æ–‡ä»¶éªŒè¯é€šè¿‡
            - âœ… å‘å¸ƒåŒ…å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡
            - âœ… è‡ªåŠ¨åŒ– CI/CD æµç¨‹

            ### ğŸ“ æ›´æ–°å†…å®¹

            æ­¤ç‰ˆæœ¬é€šè¿‡è‡ªåŠ¨åŒ– CI/CD æµç¨‹æ„å»ºï¼ŒåŒ…å«ä»¥ä¸‹æ”¹è¿›ï¼š
            - å¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶æ”¯æŒ
            - æ€§èƒ½ä¼˜åŒ–å’Œé”™è¯¯ä¿®å¤
            - å¢å¼ºçš„é”™è¯¯å¤„ç†æœºåˆ¶
            - å®Œå–„çš„æ—¥å¿—è®°å½•åŠŸèƒ½

            ---

            > ğŸ“Š æ„å»ºæŠ¥å‘Šå’Œè¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹ [Actions é¡µé¢](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        run: |
          echo "## ğŸ“Š æ„å»ºæŠ¥å‘Š" >> build-report.md
          echo "" >> build-report.md
          echo "### ğŸ—ï¸ æ„å»ºä¿¡æ¯" >> build-report.md
          echo "- **ç‰ˆæœ¬:** ${{ steps.get_version.outputs.version }}" >> build-report.md
          echo "- **æ„å»ºæ—¶é—´:** $(date -u)" >> build-report.md
          echo "- **Node.js ç‰ˆæœ¬:** ${{ matrix.node-version }}" >> build-report.md
          echo "- **å¹³å°:** $(uname -a)" >> build-report.md
          echo "" >> build-report.md
          echo "### ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶" >> build-report.md
          echo "" >> build-report.md
          echo "#### äºŒè¿›åˆ¶æ–‡ä»¶" >> build-report.md
          echo '```' >> build-report.md
          ls -la binaries/ >> build-report.md
          echo '```' >> build-report.md
          echo "" >> build-report.md
          echo "#### å‘å¸ƒåŒ…" >> build-report.md
          echo '```' >> build-report.md
          ls -la releases/ >> build-report.md
          echo '```' >> build-report.md

      - name: ä¸Šä¼ æ„å»ºæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: build-report-${{ steps.get_version.outputs.version }}
          path: build-report.md

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ steps.get_version.outputs.version }}
          path: |
            binaries/
            releases/
          retention-days: 30

      - name: æ„å»ºæˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ å‘å¸ƒæ„å»ºæˆåŠŸå®Œæˆ!"
          echo "ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}"
          echo "ç”Ÿæˆçš„æ–‡ä»¶æ•°é‡:"
          echo "  - äºŒè¿›åˆ¶æ–‡ä»¶: $(ls -1 binaries/ | wc -l) ä¸ª"
          echo "  - å‘å¸ƒåŒ…: $(ls -1 releases/ | wc -l) ä¸ª"
          echo "æ„å»ºæ—¶é—´: $(date -u)"

      - name: æ„å»ºå¤±è´¥å¤„ç†
        if: failure()
        run: |
          echo "âŒ å‘å¸ƒæ„å»ºå¤±è´¥!"
          echo "è¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹:"
          echo "  - ä»£ç ç¼–è¯‘æ˜¯å¦æˆåŠŸ"
          echo "  - ä¾èµ–å®‰è£…æ˜¯å¦æ­£å¸¸"
          echo "  - ç¯å¢ƒå˜é‡é…ç½®æ˜¯å¦æ­£ç¡®"
          echo "  - ç½‘ç»œè¿æ¥æ˜¯å¦ç¨³å®š"
          echo ""
          echo "è¯¦ç»†æ—¥å¿—è¯·æŸ¥çœ‹ Actions é¡µé¢"
          exit 1
